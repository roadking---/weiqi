// Generated by CoffeeScript 1.6.2
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  $(function() {
    var render_blog;

    console.log(data);
    init_header(data);
    $('nav #home').parent().addClass('active');
    if (!data.myself) {
      $('a#prev_blogs_btn').remove();
    }
    render_blog = function(blog) {
      var div;

      div = $(tpl('#blog_tpl')(_.defaults({
        blog: blog
      }, data))).appendTo($('#blogs ul'));
      div.find('.del').click(function() {
        return $.get("/delete_post/" + blog.id, function(res) {
          if (res.success) {
            return div.animate({
              opacity: 0,
              'background-color': '#c70851'
            }, 300, 'ease', function() {
              return div.animate({
                height: 0,
                margin: 0,
                padding: 0,
                'border-width': 0
              }, 300, 'ease', function() {
                return div.remove();
              });
            });
          }
        });
      });
      if (blog.ss) {
        return _.each(blog.ss, function(ss) {
          var moves;

          moves = data.refs[ss.gid].moves.slice(0, ss.from);
          moves = _.chain(moves).reject(function(z) {
            return _.find(ss.moves, function(y) {
              return z.n === y.n;
            });
          }).union(ss.moves).value();
          return new BoardCanvas(div.find(".ss[ss='" + ss.name + "']"), {
            size: 150
          }).render(moves);
        });
      }
    };
    if (data.blogs) {
      $('<ul></ul>').appendTo($('#blogs'));
      _.each(data.blogs, function(blog) {
        return render_blog(blog);
      });
    }
    if (data.myself && data.games.attendings.length) {
      $(tpl('#attendings_tpl')(data, {
        variable: 'data'
      })).appendTo($('#attendings')).find('li').each(function(i, li) {
        if ($(li).find('.thumb').length) {
          return new BoardCanvas($(li).find('.thumb')).render(data.refs[data.games.attendings[i]].moves);
        }
      });
    }
    if (data.games.pendings.length) {
      $(tpl('#pendings_tpl')(data, {
        variable: 'data'
      })).appendTo($('#pendings'));
    }
    return $('#prev_blogs_btn').click(function() {
      return $.get("/blog?blog_id=" + data.myself + "&tag=next", function(res) {
        var blog_id_set, _ref, _ref1;

        if (res.success) {
          if ((_ref = res.blogs) != null ? _ref.length : void 0) {
            blog_id_set = _.pluck(data.blogs, 'id');
            res.blogs = _.reject(res.blogs, function(x) {
              var _ref1;

              return _ref1 = x.id, __indexOf.call(blog_id_set, _ref1) >= 0;
            });
            data.blogs = _.union(data.blogs, res.blogs);
          }
          if ((_ref1 = res.blogs) != null ? _ref1.length : void 0) {
            return _.each(res.blogs, function(blog) {
              data.refs = _.defaults(data.refs, res.refs);
              return render_blog(blog);
            });
          }
        }
      });
    });
  });

}).call(this);
