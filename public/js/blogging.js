// Generated by CoffeeScript 1.6.2
(function() {
  var show_big_chart;

  show_big_chart = function() {
    var game;

    game = $(this).data('ss');
    game.title = 'xxx';
    if (!game.next) {
      game.next = game.moves.length ? game.moves[game.moves.length - 1].player === 'black' ? 'white' : 'black' : 'black';
    }
    return show_trying_board(game);
  };

  /*
  below deals with commeting
  */


  window.update_comment = function(comment) {
    var c, current, text, _ref, _ref1;

    c = $("<div _type='game_comment' class='blog row'/>").append("<div class='text'>" + comment.text + "</div>").append("<a class='author' href='/u/" + comment.author + "'>" + ((_ref = comment.nickname) != null ? _ref : $('#blogs').attr('_me')) + "</span>").append("<a class='step' _step='" + comment.step + "'>" + (Number(comment.step) + 1) + "</span>").append("<span class='ts'>" + comment.ts + "</span>").prependTo('#blogs');
    if (comment.snapshots) {
      text = c.find('.text').text();
      _.each(comment.snapshots, function(x, i) {
        return text = text.replace("[G" + (i + 1) + "]", "<a class='snapshot'>[G" + (i + 1) + "]</a>");
      });
      c.find('.text').html(text);
      current = (_ref1 = $('#gaming-board').data('data').get_moves()) != null ? _ref1.current : void 0;
      if (!current) {
        return;
      }
      return c.find('.text .snapshot').each(function(i) {
        var moves, _i, _ref2, _ref3, _results;

        $(this).data('ss', comment.snapshots[i]);
        moves = _.flatten([current.slice(0, +comment.snapshots[i].from + 1 || 9e9), comment.snapshots[i].moves], true);
        $(this).click(show_big_chart);
        return thumbnail(moves, {
          focus: (function() {
            _results = [];
            for (var _i = _ref2 = comment.snapshots[i].from + 1, _ref3 = moves.length - 1; _ref2 <= _ref3 ? _i <= _ref3 : _i >= _ref3; _ref2 <= _ref3 ? _i++ : _i--){ _results.push(_i); }
            return _results;
          }).apply(this),
          title: "G" + (i + 1)
        }).appendTo(c).data('ss', {
          moves: moves
        }).click(show_big_chart);
      });
    }
  };

  window.install_pub = function(type) {
    $('#pub button#submit').click(function() {
      var comment, comments, game, next_id, snapshot_list, step, text, _base, _ref, _ref1;

      snapshot_list = $(this).parent().data('snapshots');
      $(this).parent().data('snapshots', null);
      text = $.trim($(this).parent().find('textarea').val());
      if (!text || text === '') {
        return;
      }
      game = $('#gaming-board').data('data');
      step = $('#tabs a#trying').parent().hasClass('active') ? $('#trying-board').data('final_step') : game.status_quo().step;
      comments = (_ref = (_base = game.initial).comments) != null ? _ref : _base.comments = {};
      if ((_ref1 = comments[step]) == null) {
        comments[step] = {
          next_id: 0
        };
      }
      next_id = comments[step].next_id;
      comments[step][next_id] = comment = {
        id: next_id,
        ts: new Date().getTime(),
        text: text,
        step: step,
        gid: game.id,
        author: $(this).parent().attr('uid')
      };
      if (snapshot_list) {
        comment.snapshots = snapshot_list;
      }
      comments[step].next_id++;
      $(this).parent().find('textarea').val('');
      switch (type) {
        case 'dapu':
          localStorage.dapu = JSON.stringify(game.initial);
          break;
        case 'connected':
          delete comment.id;
          game = $('#gaming-board').data('data');
          if (game.connected) {
            game.send_comment($('#gaming-board').attr('socket'), comment);
          } else {
            $.post('/comment', {
              comment: comment,
              game: $('#gaming-board').attr('socket')
            }, function(rlt) {
              return console.log(rlt);
            });
          }
      }
      comment.ts = moment(Number(comment.ts)).format('YYYY/MM/DD HH:mm');
      return update_comment(comment);
    });
    return $('#pub button#add_chart').click(function() {
      var from, snapshot, snapshot_list, text, _ref;

      if ($('#tabs a#trying').parent().hasClass('active')) {
        from = $('#trying-board').data('final_step');
        snapshot = {
          moves: $('#trying-board').data('data').get_moves().current.slice(from + 1),
          from: from
        };
        console.log(snapshot_list = (_ref = $(this).parent().data('snapshots')) != null ? _ref : []);
        snapshot_list.push(snapshot);
        $(this).parent().find('textarea').val(text = $(this).parent().find('textarea').val() + ("[G" + snapshot_list.length + "]"));
        return $(this).parent().data('snapshots', snapshot_list);
      } else {
        return $('#tabs a#trying').click();
      }
    });
  };

  window.clear_pub_input = function() {
    $('#pub').data('snapshots', null);
    return $('#pub textarea').val('');
  };

  /*
  below deals with blogs
  */


  $(function() {
    var make_up_blog, render_blogs;

    $('#pub_blog button').click(function() {
      var text;

      text = $('#pub_blog textarea').val();
      if (text === '') {
        return;
      }
      return $.post('/blog', {
        text: text
      }, function(res) {
        return $('#pub_blog textarea').val('');
      });
    });
    make_up_blog = function(blog, refs) {
      var b, _ref;

      b = $("<div _type='" + blog.type + "' id='" + blog.id + "' class='blog row'/>");
      if (blog.text) {
        b.append("<div class='text'>" + blog.text + "</div>");
      }
      if (blog.author) {
        b.append("<a href='/u/" + blog.author + "' class='author'>" + ((_ref = refs[blog.author]) != null ? _ref.nickname : void 0) + "</a>");
      }
      if (blog.step) {
        b.append("<a _step=" + blog.step + " class='step'>" + (Number(blog.step) + 1) + "</a>");
      }
      if (blog.ts) {
        return b.append("<span _ts='" + blog.ts + "' class='ts'>" + (moment(Number(blog.ts) * 1000).format('YYYY/MM/DD HH:mm')) + "</span>");
      }
    };
    (render_blogs = function() {
      $('.ts').each(function(i) {
        return $(this).text(moment(Number($(this).attr('_ts')) * 1000).format('YYYY/MM/DD HH:mm'));
      });
      return $('.blog .snapshots').each(function(i) {
        var game_moves,
          _this = this;

        game_moves = $(this).attr('game_moves') ? JSON.parse($(this).attr('game_moves')) : null;
        return _.each(JSON.parse($(this).attr('_ss')), function(ss, i) {
          var cid, gid, _i, _ref, _ref1, _results;

          gid = $(_this).attr('gid');
          cid = $(_this).parent().attr('id');
          ss.moves = _.chain([game_moves != null ? game_moves.slice(0, +ss.from + 1 || 9e9) : void 0, ss.moves]).flatten().compact().value();
          return thumbnail(ss.moves, {
            focus: (function() {
              _results = [];
              for (var _i = _ref = ss.from + 1, _ref1 = ss.moves.length - 1; _ref <= _ref1 ? _i <= _ref1 : _i >= _ref1; _ref <= _ref1 ? _i++ : _i--){ _results.push(_i); }
              return _results;
            }).apply(this),
            title: "G" + (i + 1)
          }).appendTo($(_this)).data('ss', ss).wrap("<a href='/game/weiqi/" + gid + "?c=" + cid + "&ss=" + i + "'/>");
        });
      });
    })();
    $('#recent_blogs_btn').click(function() {
      var blog_id;

      blog_id = $('#blogs').attr('blog_id');
      return $.get('/blog', {
        blog_id: blog_id,
        tag: 'recent'
      }, function(data) {
        var recents;

        if (data && data !== 'error') {
          recents = _.toArray($('<div/>').append(data).children().filter(function() {
            var id;

            id = $(this).attr('id');
            return !$("#blogs #blogs_list .blog[id='" + id + "']").length;
          }));
          console.log(recents.length);
          _.each(recents.reverse(), function(x) {
            return $(x).detach().prependTo($('#blogs #blogs_list'));
          });
          return render_blogs();
        }
      });
    });
    $('#prev_blogs_btn').click(function() {
      var blog_id;

      blog_id = $('#blogs').attr('blog_id');
      return $.get('/blog', {
        blog_id: blog_id,
        tag: 'next'
      }, function(data) {
        if (data && data !== 'error') {
          $('#blogs #blogs_list').append(data);
          return render_blogs();
        }
      });
    });
    return $('.blog .del').click(function() {
      var _this = this;

      return $.get("/delete_blog/" + $(this).parent().attr('id'), function(data) {
        if (data != null ? data.success : void 0) {
          return $(_this).parent().remove();
        }
      });
    });
  });

}).call(this);
