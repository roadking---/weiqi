// Generated by CoffeeScript 1.6.2
(function() {
  var find, find_block, move, move_step, repeal, retract;

  find = function(stones, pos) {
    return _.filter(stones, function(x) {
      return !x.repealed && x.pos[0] === pos[0] && x.pos[1] === pos[1];
    })[0];
  };

  find_block = function(stones, pos) {
    var adjacent, block, liberty, newly_found, opposite, stone;

    stone = find(stones, pos);
    if (!stone) {
      return null;
    }
    block = [stone];
    liberty = [];
    opposite = [];
    newly_found = [stone];
    while (newly_found.length) {
      adjacent = _.chain(newly_found).map(function(x) {
        return [[x.pos[0] - 1, x.pos[1]], [x.pos[0] + 1, x.pos[1]], [x.pos[0], x.pos[1] - 1], [x.pos[0], x.pos[1] + 1]];
      }).flatten(true).filter(function(x) {
        return x[0] >= 0 && x[0] <= 18 && x[1] >= 0 && x[1] <= 18;
      }).uniq().reject(function(x) {
        return _.chain([block, liberty, opposite]).flatten().some(function(y) {
          return y.pos[0] === x[0] && y.pos[1] === x[1];
        }).value();
      }).map(function(x) {
        var _ref;

        return (_ref = find(stones, x)) != null ? _ref : {
          pos: x,
          player: 'none'
        };
      }).value();
      if (adjacent.length) {
        newly_found = _.filter(adjacent, function(x) {
          return x.player === stone.player;
        });
        liberty.push(_.filter(adjacent, function(x) {
          return x.player === 'none';
        }));
        opposite.push(_.filter(adjacent, function(x) {
          return x.player !== 'none' && x.player !== stone.player;
        }));
        block = _.flatten([block, newly_found]);
      } else {
        newly_found = [];
      }
    }
    return {
      block: block,
      liberty: _.chain(liberty).flatten().pluck('pos').groupBy(function(x) {
        return x.join(',');
      }).values().pluck(0).value(),
      opposite: _.chain(opposite).flatten().groupBy(function(x) {
        return x.pos.join(',');
      }).values().pluck(0).value()
    };
  };

  move = function(stones, step, test) {
    var rlt, target_block, _ref;

    if (test == null) {
      test = false;
    }
    if (find(stones, step.pos)) {
      return new Error("already exists in " + step.pos);
    }
    if ((_ref = step.n) == null) {
      step.n = stones.length;
    }
    stones.push(step);
    rlt = find_block(stones, step.pos);
    target_block = _.chain(rlt.opposite).map(function(x, i) {
      var block;

      if (i === 0) {
        this.target_block = [];
      }
      if (_.chain(this.target_block).pluck('block').flatten().some(function(y) {
        return x.pos[0] === y.pos[0] && x.pos[1] === y.pos[1];
      }).value()) {
        return null;
      }
      block = find_block(stones, x.pos);
      this.target_block.push(block);
      return block;
    }).compact().reject(function(x) {
      return x.liberty.length;
    }).value();
    if (test) {
      stones.pop();
    }
    if (target_block.length) {
      return target_block;
    } else if (rlt.liberty.length) {
      return null;
    } else {
      if (!test) {
        stones.pop();
      }
      throw new Error("not allowed in " + step.pos + " " + step.player);
    }
  };

  repeal = function(stones, block) {
    return _.each(block.block, function(x) {
      return x.repealed = stones.length - 1;
    });
  };

  move_step = function(stones, step) {
    var blocks, deprecated, last, taken, try_move;

    if (_.any(stones, function(x) {
      return !x.repealed && x.pos[0] === step.pos[0] && x.pos[1] === step.pos[1];
    })) {
      throw new Error("already exists: not allowed in " + (JSON.stringify(step)));
    }
    try_move = function() {
      var blocks;

      blocks = move(stones, step);
      if (blocks) {
        _.each(blocks, function(x) {
          return repeal(stones, x);
        });
      }
      return blocks;
    };
    last = (stones != null ? stones.length : void 0) > 1 ? stones[stones.length - 1] : null;
    blocks = try_move();
    taken = _.pluck(blocks, 'block');
    if (last && taken.length === 1 && taken[0].length === 1) {
      taken = taken[0][0];
      if (taken.player === last.player && _.every([0, 1], function(i) {
        return last.pos[i] === taken.pos[i];
      })) {
        if (taken = _.where(stones, {
          repealed: last.n
        })) {
          if (taken.length === 1) {
            taken = taken[0];
            if (taken.player === step.player && _.every([0, 1], function(i) {
              return step.pos[i] === taken.pos[i];
            })) {
              deprecated = stones.pop();
              _.each(stones, function(x) {
                if (x.repealed === deprecated.n) {
                  return delete x.repealed;
                }
              });
              throw new Error("dajie: not allowed in " + step.pos + " " + step.player);
            }
          }
        }
      }
    }
    return blocks;
  };

  if (typeof exports !== "undefined" && exports !== null) {
    exports.move_step = move_step;
  }

  if (typeof window !== "undefined" && window !== null) {
    window.move_step = move_step;
  }

  retract = function(stones) {
    var last_step;

    if (!stones.length) {
      return stones;
    }
    last_step = stones.pop();
    _.chain(stones).where({
      repealed: last_step.n
    }).each(function(x) {
      return delete x.repealed;
    });
    return stones;
  };

  if (typeof exports !== "undefined" && exports !== null) {
    exports.retract = retract;
  }

  if (typeof window !== "undefined" && window !== null) {
    window.retract = retract;
  }

}).call(this);
